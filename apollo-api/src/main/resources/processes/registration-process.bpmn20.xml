<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:flowable="http://flowable.org/bpmn"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/processdef">
  <process id="registration" name="Registration" isExecutable="true">
    <startEvent id="theStart"/>
    <sequenceFlow id="flow1" sourceRef="theStart" targetRef="selectUserType"/>
    <exclusiveGateway id="selectUserType"/>
    <sequenceFlow id="emailValidationTokenFlow" sourceRef="selectUserType" targetRef="emailValidationToken">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 5}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow22" sourceRef="selectUserType" targetRef="saveManufacturerData">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 4}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow23" sourceRef="selectUserType" targetRef="savePVOCPartnerData">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 6}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow25" sourceRef="selectUserType" targetRef="saveManufacturerData">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 21}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow31" sourceRef="selectUserType" targetRef="saveManufacturerData">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 5}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow32" sourceRef="selectUserType" targetRef="emailValidationToken">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 101}]]></conditionExpression>
    </sequenceFlow>
<!--    <sequenceFlow id="flow27" sourceRef="selectUserType" targetRef="saveManufacturerData">-->
<!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 42}]]></conditionExpression>-->
<!--    </sequenceFlow>-->
<!--    <sequenceFlow id="flow28" sourceRef="selectUserType" targetRef="saveManufacturerData">-->
<!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 44}]]></conditionExpression>-->
<!--    </sequenceFlow>-->
<!--    <sequenceFlow id="flow29" sourceRef="selectUserType" targetRef="saveManufacturerData">-->
<!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 45}]]></conditionExpression>-->
<!--    </sequenceFlow>-->
<!--    <sequenceFlow id="flow30" sourceRef="selectUserType" targetRef="saveManufacturerData">-->
<!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 46}]]></conditionExpression>-->
<!--    </sequenceFlow>-->
<!--    <sequenceFlow id="flow" sourceRef="selectUserType" targetRef="savePVOCPartnerData">-->
<!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${userTypeId == 4}]]></conditionExpression>-->
<!--    </sequenceFlow>-->
<!--      /** Add gateway to evaluate kra's response-->
    <serviceTask id="emailValidationToken" name="emailValidationToken" flowable:async="true"
                 flowable:resultVariable="status"
                 flowable:expression="${prepareEmailForSending.sendEmail(user, sr, map)}"/>
<!--    check kra-->
    <serviceTask id="saveManufacturerData" name="saveManufacturerData" flowable:async="true"
                 flowable:resultVariable="status"
                 flowable:expression="${prepareEmailForSending.sendToKra(user, sr, map)}"/>
<!--check BRS-->
    <serviceTask id="checkBrsValidity" name="checkBrsValidity" flowable:async="true"
                 flowable:resultVariable="status"
                 flowable:expression="${prepareEmailForSending.checkBrs(user, sr, map)}"/>

    <serviceTask id="savePVOCPartnerData" name="savePVOCPartnerData" flowable:async="true"
                 flowable:resultVariable="status"
                 flowable:expression="${prepareEmailForSending.sendEmail(user, sr, map)}"/>
    <sequenceFlow id="evaluateStatusFlow" name="evaluateStatusFlow" sourceRef="emailValidationToken"
                  targetRef="evaluateStatus"/>

    <exclusiveGateway id="evaluateStatus" name="evaluateStatus"/>

    <sequenceFlow id="emailValidationTokenSuccessFlow" sourceRef="evaluateStatus" targetRef="validateToken">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${status >= 30 }]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow40" sourceRef="saveManufacturerData" targetRef="evaluateKraResponse" />
    <exclusiveGateway id="evaluateKraResponse"/>


      <!--    checks continue flag of kra validation -->
      <sequenceFlow id="flow41" sourceRef="evaluateKraResponse" targetRef="validateBrs">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${continue == true }]]></conditionExpression>
      </sequenceFlow>


      <sequenceFlow id="flow42" sourceRef="evaluateKraResponse" targetRef="sendFailureEmail">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${continue == false }]]></conditionExpression>
      </sequenceFlow>
<!--    Service task that   -->
<!--    BRS -->
    <exclusiveGateway id="validateBrs"/>

<!--    <sequenceFlow id="flow43" sourceRef="evaluateKraResponse" targetRef="validateBrs" />-->

    <sequenceFlow id="flow44" sourceRef="validateBrs" targetRef="emailValidationToken">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${continue == true }]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow45" sourceRef="validateBrs" targetRef="sendFailureEmail">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${continue == false }]]></conditionExpression>
    </sequenceFlow>



    <sequenceFlow id="emailValidationTokenFailureFlow" sourceRef="evaluateStatus" targetRef="sendFailureEmail">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${status <= 25 }]]></conditionExpression>
    </sequenceFlow>
    <serviceTask id="sendFailureEmail" name="sendFailureEmail" flowable:async="true" flowable:resultVariable="status"
                 flowable:expression="${prepareEmailForSending.sendEmail(user, sr, map)}"/>
    <userTask id="validateToken" name="Validate Email using token" flowable:candidateGroups="${user.userName}">
      <documentation>User selects a link to validate the email based on a token we have generated</documentation>
    </userTask>
    <endEvent id="theEnd"/>
    <sequenceFlow id="flow24" sourceRef="sendFailureEmail" targetRef="theEnd"/>
    <exclusiveGateway id="sid-c2c275f0-22bb-488b-b343-5005214fb4a2" name="evaluateStatus"/>
    <!--    <sequenceFlow id="sid-c2c275f0-22bb-488b-b343-5005214fb4a4" sourceRef="sid-c2c275f0-22bb-488b-b343-5005214fb4a2" targetRef="sendAccountActivation">-->
    <!--      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${status >= 30 }]]></conditionExpression>-->
    <!--    </sequenceFlow>-->
    <sequenceFlow id="sid-1d1348e1-b2e4-4e92-a9b9-917af24c4f34" sourceRef="sid-c2c275f0-22bb-488b-b343-5005214fb4a2"
                  targetRef="sendFailureEmail">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${status <= 25 }]]></conditionExpression>
    </sequenceFlow>
    <userTask id="sendAccountActivation" name="Send Account Activation">
      <documentation>Send and email to allow user to reset password</documentation>
    </userTask>
    <sequenceFlow id="flow26" sourceRef="sendAccountActivation" targetRef="theEnd"/>
    <sequenceFlow id="sid-e59b8006-3885-4488-97dc-2ec9a46ce302" sourceRef="validateToken"
                  targetRef="sid-c2c275f0-22bb-488b-b343-5005214fb4a2"/>
    <sequenceFlow id="sid-9ae3e60f-6a10-4d1b-8e91-d04105198e82" sourceRef="sid-c2c275f0-22bb-488b-b343-5005214fb4a2"
                  targetRef="sendAccountActivation">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${status >= 30 }]]></conditionExpression>
    </sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_registration">
    <bpmndi:BPMNPlane bpmnElement="registration" id="BPMNPlane_registration">
      <bpmndi:BPMNShape bpmnElement="theStart" id="BPMNShape_theStart">
        <omgdc:Bounds height="35.0" width="35.0" x="0.0" y="175.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="selectUserType" id="BPMNShape_selectUserType">
        <omgdc:Bounds height="40.0" width="40.0" x="80.0" y="170.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="emailValidationToken" id="BPMNShape_emailValidationToken">
        <omgdc:Bounds height="60.0" width="100.0" x="170.0" y="160.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="saveManufacturerData" id="BPMNShape_saveManufacturerData">
        <omgdc:Bounds height="60.0" width="100.0" x="170.0" y="0.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="savePVOCPartnerData" id="BPMNShape_savePVOCPartnerData">
        <omgdc:Bounds height="60.0" width="100.0" x="170.0" y="320.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="evaluateStatus" id="BPMNShape_evaluateStatus">
        <omgdc:Bounds height="40.0" width="40.0" x="320.0" y="170.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="sendFailureEmail" id="BPMNShape_sendFailureEmail">
        <omgdc:Bounds height="60.0" width="100.0" x="400.0" y="10.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="validateToken" id="BPMNShape_validateToken">
        <omgdc:Bounds height="60.0" width="100.0" x="410.0" y="240.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="theEnd" id="BPMNShape_theEnd">
        <omgdc:Bounds height="35.0" width="35.0" x="922.0" y="37.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="sid-c2c275f0-22bb-488b-b343-5005214fb4a2"
                        id="BPMNShape_sid-c2c275f0-22bb-488b-b343-5005214fb4a2">
        <omgdc:Bounds height="40.0" width="40.0" x="620.0" y="249.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="sendAccountActivation" id="BPMNShape_sendAccountActivation">
        <omgdc:Bounds height="55.0" width="105.0" x="705.0" y="247.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="35.0" y="192.0"/>
        <omgdi:waypoint x="80.0" y="190.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="emailValidationTokenFlow" id="BPMNEdge_emailValidationTokenFlow">
        <omgdi:waypoint x="120.0" y="190.0"/>
        <omgdi:waypoint x="170.0" y="190.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow22" id="BPMNEdge_flow22">
        <omgdi:waypoint x="120.0" y="190.0"/>
        <omgdi:waypoint x="132.0" y="190.0"/>
        <omgdi:waypoint x="132.0" y="30.0"/>
        <omgdi:waypoint x="170.0" y="30.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow23" id="BPMNEdge_flow23">
        <omgdi:waypoint x="120.0" y="190.0"/>
        <omgdi:waypoint x="132.0" y="190.0"/>
        <omgdi:waypoint x="132.0" y="350.0"/>
        <omgdi:waypoint x="170.0" y="350.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="evaluateStatusFlow" id="BPMNEdge_evaluateStatusFlow">
        <omgdi:waypoint x="270.0" y="190.0"/>
        <omgdi:waypoint x="320.0" y="190.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="12.0" width="100.0" x="270.0" y="190.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="emailValidationTokenSuccessFlow" id="BPMNEdge_emailValidationTokenSuccessFlow">
        <omgdi:waypoint x="360.0" y="190.0"/>
        <omgdi:waypoint x="372.0" y="190.0"/>
        <omgdi:waypoint x="372.0" y="270.0"/>
        <omgdi:waypoint x="410.0" y="270.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="emailValidationTokenFailureFlow" id="BPMNEdge_emailValidationTokenFailureFlow">
        <omgdi:waypoint x="360.0" y="190.0"/>
        <omgdi:waypoint x="372.0" y="190.0"/>
        <omgdi:waypoint x="372.0" y="110.0"/>
        <omgdi:waypoint x="450.0" y="70.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow24" id="BPMNEdge_flow24">
        <omgdi:waypoint x="500.0" y="40.0"/>
        <omgdi:waypoint x="939.0" y="37.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-1d1348e1-b2e4-4e92-a9b9-917af24c4f34"
                       id="BPMNEdge_sid-1d1348e1-b2e4-4e92-a9b9-917af24c4f34">
        <omgdi:waypoint x="640.0" y="249.0"/>
        <omgdi:waypoint x="583.0" y="145.0"/>
        <omgdi:waypoint x="450.0" y="70.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow26" id="BPMNEdge_flow26">
        <omgdi:waypoint x="810.0" y="274.0"/>
        <omgdi:waypoint x="943.25" y="274.5"/>
        <omgdi:waypoint x="939.5" y="72.0"/>
      </bpmndi:BPMNEdge>
      <bpmdi:BPMNEdge xmlns:bpmdi="http://www.omg.org/spec/BPMN/20100524/DI"
                      id="edge-f6e7fd5d-cbb3-42f9-8049-e21a87c24c51"
                      bpmnElement="sid-e59b8006-3885-4488-97dc-2ec9a46ce302">
        <omgdi:waypoint x="510.0" y="270.0"/>
        <omgdi:waypoint x="620.0" y="269.0"/>
      </bpmdi:BPMNEdge>
      <bpmdi:BPMNEdge xmlns:bpmdi="http://www.omg.org/spec/BPMN/20100524/DI"
                      id="edge-f2869afd-e78a-467a-bf48-73fddef613ea"
                      bpmnElement="sid-9ae3e60f-6a10-4d1b-8e91-d04105198e82">
        <omgdi:waypoint x="660.0" y="269.0"/>
        <omgdi:waypoint x="705.0" y="274.5"/>
      </bpmdi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
